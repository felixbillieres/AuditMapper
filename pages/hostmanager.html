<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Host Manager - AuditMapper</title>
    <!-- Bootstrap CSS (Optionnel) -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- VOTRE CSS EXTERNE -->
    <link rel="stylesheet" href="/assets/css/styles.css">
    <!-- CSS EXPORT/IMPORT -->
    <link rel="stylesheet" href="/assets/css/export-import.css">

    <!-- jQuery FIRST -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    
    <!-- Inclure Vis.js -->
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <!-- Inclure Marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Inclure DOMPurify -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.3.10/purify.min.js"></script>
    <!-- JSZip et FileSaver -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- HTML2PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Markdown Editor Dependencies -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
    <script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
    <!-- Highlight.js for code syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    
    <!-- Script pour les permissions de presse-papiers -->
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Vérifier si l'API clipboard est supportée
                if (navigator.clipboard && navigator.clipboard.read) {
                    console.log('API Clipboard supportée');
                } else {
                    console.log('API Clipboard non supportée, collage d\'images limité');
                }
            } catch (error) {
                console.log('Erreur lors de la vérification des permissions:', error);
            }
        });
    </script>
</head>
<body class="">

    <!-- Bouton Sidebar Toggle -->
    <button id="sidebar-toggle" class="sidebar-toggle">
        <i>☰</i>
    </button>

    <!-- Sidebar Unifiée -->
    <div id="sidebar" class="sidebar">
        <a href="/index.html" class="sidebar-header">
            <img src="/assets/photos/logo.png" alt="AuditMapper" class="sidebar-logo">
            <div class="sidebar-header-text">
                <h2>AuditMapper</h2>
                <p>Security Assessment Suite</p>
            </div>
        </a>
        
        <div class="sidebar-content">
            <ul class="sidebar-nav">
                <div class="sidebar-category">Management</div>
                <li class="sidebar-nav-item">
                    <a href="/pages/hostmanager.html" class="sidebar-nav-link active">
                        <i>🖥️</i> Host Manager
                    </a>
                </li>
                
                <div class="sidebar-category">Outils</div>
                <li class="sidebar-nav-item">
                    <a href="/pages/tools.html" class="sidebar-nav-link">
                        <i>🛠️</i> Bibliothèque d'outils
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="/pages/file_transfer.html" class="sidebar-nav-link">
                        <i>🔄</i> Transfert Fichiers
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="/pages/pivoting_guide.html" class="sidebar-nav-link">
                        <i>🔀</i> Pivoting Guide
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="/pages/privesc.html" class="sidebar-nav-link">
                        <i>🔑</i> Guide Privesc
                    </a>
                </li>
                
                <div class="sidebar-category">Parsers & Générateurs</div>
                <li class="sidebar-nav-item">
                    <a href="/pages/hostsmaker.html" class="sidebar-nav-link">
                        <i>🌐</i> Config Generator
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="/pages/grepmaster.html" class="sidebar-nav-link">
                        <i>🔍</i> Grep Master
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a href="/pages/vulnreport.html" class="sidebar-nav-link">
                        <i>🔒</i> Rapport de Vulnérabilités
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <!-- Header -->
    <header id="main-header" class="main-header">
        <div class="header-container">
            <h1>Host Manager</h1>
            <div class="header-controls">
                <div class="language-selector">
                    <button id="languageDropdown" class="language-dropdown">
                        <i class="icon-language">🌍</i>
                        <span id="currentLanguage">Français</span>
                        <i class="dropdown-arrow">▼</i>
                    </button>
                    <div id="languageMenu" class="language-menu">
                        <div class="language-option" data-lang="fr">
                            <span class="language-flag">🇫🇷</span>Français
                        </div>
                        <div class="language-option" data-lang="en">
                            <span class="language-flag">🇬🇧</span>English
                        </div>
                    </div>
                </div>
                <button id="toggleTheme" class="theme-toggle">
                    <i class="icon-theme">🌓</i>
                </button>
            </div>
        </div>
    </header>

    <!-- Contenu principal -->
    <div id="main-content" class="main-content">
        <!-- ========================================== -->
        <!-- == SECTION EXPORTATION/IMPORTATION COMPLÈTE == -->
        <!-- ========================================== -->
        <div id="nodeExportSection" class="collapsible-section">
            <div class="collapsible-header" onclick="toggleExportImportSection()">
                <h5 class="mb-0">📦 Export & Import Complet</h5>
                <div class="d-flex align-items-center">
                    <small class="text-muted mr-2">Sauvegardez et partagez tout votre travail</small>
                    <span class="collapsible-toggle">▼</span>
                </div>
            </div>
            <div class="collapsible-content" id="exportImportContent">
                
                <!-- Section Export -->
                <div class="export-import-section mb-4">
                    <h6 class="section-title">📤 Exportation</h6>
                    <p class="card-text small text-muted mb-3">
                        Exportez toutes vos données (catégories, hosts, vulnérabilités, credentials, étapes d'exploitation, 
                        connexions, screenshots, outputs) dans une archive organisée.
                    </p>

                    <!-- Option 1: File System Access API -->
                    <div class="export-option mb-3 pb-3 border-bottom">
                        <div class="d-flex align-items-center mb-2">
                            <h6 class="mb-0 mr-2">🗂️ Export Direct vers Dossier</h6>
                            <span class="badge badge-info">Chrome/Edge</span>
                        </div>
                        <p class="card-text small text-muted">
                            Crée directement l'arborescence de dossiers et fichiers dans un dossier que vous sélectionnez.
                            <strong class="text-warning">Nécessite votre autorisation explicite.</strong>
                        </p>
                        <div class="d-flex justify-content-start align-items-center flex-wrap">
                            <button type="button" id="selectExportDirBtn" class="btn btn-outline-secondary btn-sm mr-2 mb-2">
                                <i class="icon-folder">📁</i> Choisir le Dossier Destination...
                            </button>
                            <span id="selectedDirPath" class="mr-3 mb-2 small text-muted">Aucun dossier sélectionné</span>
                            <button type="button" id="executeNodeExportBtn" class="btn btn-primary btn-sm mb-2" disabled>
                                <i class="icon-download">⬇️</i> Exporter vers le Dossier
                            </button>
                        </div>
                    </div>

                    <!-- Option 2: Export ZIP Amélioré -->
                    <div class="export-option">
                        <div class="d-flex align-items-center mb-2">
                            <h6 class="mb-0 mr-2">📦 Export Archive ZIP Complète</h6>
                            <span class="badge badge-success">Recommandé</span>
                        </div>
                        <p class="card-text small text-muted mb-3">
                            Génère une archive ZIP complète avec tous vos données, rapports automatiques, 
                            credentials agrégés, et structure organisée. <strong>Idéal pour partager avec des collègues.</strong>
                        </p>
                        
                        <div class="zip-export-features mb-3">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="small font-weight-bold">📋 Contenu inclus :</h6>
                                    <ul class="list-unstyled small">
                                        <li>✅ Session data (JSON pour re-import)</li>
                                        <li>✅ Hosts détaillés par catégorie (Markdown)</li>
                                        <li>✅ Credentials agrégés (TXT + CSV)</li>
                                        <li>✅ Étapes d'exploitation documentées</li>
                                        <li>✅ Screenshots et outputs organisés</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="small font-weight-bold">📊 Rapports automatiques :</h6>
                                    <ul class="list-unstyled small">
                                        <li>📄 Résumé exécutif</li>
                                        <li>🔧 Rapport technique détaillé</li>
                                        <li>⚔️ Analyse Kill Chain</li>
                                        <li>🔑 Rapport credentials</li>
                                        <li>🗺️ Analyse réseau et pivots</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-start align-items-center flex-wrap">
                            <button type="button" id="executeNodeExportZipBtn" class="btn btn-success btn-sm mr-2 mb-2">
                                <i class="icon-zip">📦</i> Générer Archive ZIP
                            </button>
                            <small class="text-muted mb-2">Archive complète avec structure organisée</small>
                        </div>
                    </div>

                    <!-- Option 3: Export Session Simple -->
                    <div class="export-option mt-3 pt-3 border-top">
                        <div class="d-flex align-items-center mb-2">
                            <h6 class="mb-0 mr-2">💾 Export Session JSON</h6>
                            <span class="badge badge-secondary">Simple</span>
                        </div>
                        <p class="card-text small text-muted mb-3">
                            Export rapide de toutes les données de session au format JSON. 
                            <strong>Idéal pour sauvegardes rapides et transferts.</strong>
                        </p>
                        
                        <div class="d-flex justify-content-start align-items-center flex-wrap">
                            <button id="exportSessionBtn" class="btn btn-outline-primary btn-sm mr-2 mb-2">
                                <i class="icon-export">💾</i> Exporter Session
                            </button>
                            <small class="text-muted mb-2">Fichier JSON avec toutes les données</small>
                        </div>
                    </div>
                </div>

                <!-- Section Import -->
                <div class="export-import-section mb-4">
                    <h6 class="section-title">📥 Importation</h6>
                    <p class="card-text small text-muted mb-3">
                        Importez vos données depuis une archive ZIP ou un fichier JSON de session.
                    </p>

                    <!-- Option 1: Import ZIP -->
                    <div class="import-option mb-3 pb-3 border-bottom">
                        <div class="d-flex align-items-center mb-2">
                            <h6 class="mb-0 mr-2">📦 Import Archive ZIP</h6>
                            <span class="badge badge-success">Recommandé</span>
                        </div>
                        <p class="card-text small text-muted mb-3">
                            Importez une archive ZIP complète avec tous les screenshots, outputs et rapports.
                            <strong>Conserve la structure complète des données.</strong>
                        </p>
                        
                        <div class="d-flex justify-content-start align-items-center flex-wrap">
                            <button type="button" id="importZipBtn" class="btn btn-success btn-sm mr-2 mb-2">
                                <i class="icon-import">📦</i> Importer Archive ZIP
                            </button>
                            <small class="text-muted mb-2">Archive complète avec screenshots</small>
                        </div>
                    </div>

                    <!-- Option 2: Import Session JSON -->
                    <div class="import-option">
                        <div class="d-flex align-items-center mb-2">
                            <h6 class="mb-0 mr-2">💾 Import Session JSON</h6>
                            <span class="badge badge-secondary">Simple</span>
                        </div>
                        <p class="card-text small text-muted mb-3">
                            Importez un fichier JSON de session. 
                            <strong>Note : Les screenshots ne sont pas inclus dans ce format.</strong>
                        </p>
                        
                        <div class="d-flex justify-content-start align-items-center flex-wrap">
                            <label for="importSessionInput" class="btn btn-outline-warning btn-sm mr-2 mb-2">
                                <i class="icon-import">💾</i> Importer Session
                            </label>
                            <input type="file" id="importSessionInput" accept=".json" style="display: none;">
                            <small class="text-muted mb-2">Fichier JSON de session</small>
                        </div>
                    </div>
                </div>

                <!-- Section Gestion des Données -->
                <div class="export-import-section">
                    <h6 class="section-title">🗑️ Gestion des Données</h6>
                    <p class="card-text small text-muted mb-3">
                        Actions de maintenance et de nettoyage des données.
                    </p>
                    
                    <div class="d-flex justify-content-start align-items-center flex-wrap">
                        <button id="removeAllDataBtn" class="btn btn-danger btn-sm mr-2 mb-2">
                            <i class="icon-delete">🗑️</i> Supprimer Toutes les Données
                        </button>
                        <small class="text-muted mb-2">⚠️ Action irréversible - sauvegardez d'abord !</small>
                    </div>
                </div>
            </div>
        </div>
        <!-- ========================================== -->
        <!-- == FIN SECTION EXPORTATION/IMPORTATION == -->
        <!-- ========================================== -->

        <!-- Gestion des Catégories et Hôtes -->
        <div class="category-section">
            <div class="category-header">
                <h4>Gestion des Hôtes par Catégorie</h4>
                <div class="category-header-buttons">
                    <button id="addCategoryBtn" class="btn btn-primary btn-sm">
                        <i class="fas fa-plus"></i> Nouvelle Catégorie
                    </button>
                    <button id="toggleAutoParseBtn" class="btn btn-outline-secondary btn-sm" data-toggle="collapse" data-target="#autoParseSection">
                        🚀 Parsing Auto
                    </button>
                </div>
            </div>
            
            <!-- Section Parsing Automatique (déroulante) -->
            <div class="collapse" id="autoParseSection">
                <div class="card mt-3">
                    <div class="card-header">
                        <h6 class="mb-0">🚀 Parsing Automatique d'Outputs</h6>
                        <small class="text-muted">Collez vos outputs de balayage pour créer automatiquement les hosts</small>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="autoParseCategory">Catégorie cible:</label>
                                    <select id="autoParseCategory" class="form-control">
                                        <option value="">Sélectionnez une catégorie...</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="autoParseType">Type d'output:</label>
                                    <select id="autoParseType" class="form-control">
                                        <option value="fping">fping -agq (IPs simples)</option>
                                        <option value="netexec">Netexec/SMB (détails complets)</option>
                                        <option value="nmap">Nmap (format standard)</option>
                                        <option value="custom">Format personnalisé</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="autoParseInput">Output à parser:</label>
                            <textarea id="autoParseInput" class="form-control" rows="6" 
                                      placeholder="Collez ici votre output de balayage...

Exemples:
• fping -agq 192.168.110.0/24
192.168.110.1
192.168.110.51

• Netexec/SMB
SMB         192.168.1.101    445    DC2012A          [*] Windows Server 2012 R2 Standard

• Nmap
Nmap scan report for 192.168.1.1
Host is up (0.0005s latency)."></textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="autoParseZone">Zone par défaut:</label>
                                    <input type="text" id="autoParseZone" class="form-control" placeholder="ex: DMZ, LAN, WAN" value="LAN">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="autoParseSystem">Système par défaut:</label>
                                    <select id="autoParseSystem" class="form-control">
                                        <option value="Unknown">Unknown</option>
                                        <option value="Windows">Windows</option>
                                        <option value="Linux">Linux</option>
                                        <option value="macOS">macOS</option>
                                        <option value="Network Device">Network Device</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input" id="autoParsePreview" checked>
                                <label class="custom-control-label" for="autoParsePreview">
                                    Afficher l'aperçu avant création
                                </label>
                            </div>
                        </div>
                        
                        <div class="btn-group">
                            <button type="button" id="parseOutputBtn" class="btn btn-primary">
                                🔍 Parser l'Output
                            </button>
                            <button type="button" id="createHostsBtn" class="btn btn-success" style="display: none;">
                                ✅ Créer les Hosts
                            </button>
                            <button type="button" id="clearParseBtn" class="btn btn-secondary">
                                🗑️ Effacer
                            </button>
                        </div>
                        
                        <!-- Aperçu des hosts à créer -->
                        <div id="parsePreviewContainer" class="mt-3" style="display: none;">
                            <h6>📋 Aperçu des hosts à créer:</h6>
                            <div id="parsePreviewList" class="border rounded p-3 bg-light">
                                <!-- Les hosts parsés seront affichés ici -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="category-tabs-container">
                <ul id="categoryTabs"></ul>
            </div>
            
            <div id="categoryContentContainer">
                <p class="text-muted text-center">Sélectionnez une catégorie ou créez-en une nouvelle pour commencer.</p>
            </div>
        </div>





        <!-- Section Carte Réseau -->
        <div class="card network-section">
            <div class="card-header">
                <h5 class="mb-0">🗺️ Carte Réseau Interactive</h5>
                <small class="text-muted">Visualisation des systèmes et de leurs connexions</small>
            </div>
            
            <div class="network-controls">
                <div class="network-toolbar">
                    <div class="btn-group btn-group-sm">
                        <button id="networkZoomIn" class="btn btn-outline-primary" title="Zoom avant (Ctrl++)">
                            🔍+
                        </button>
                        <button id="networkZoomOut" class="btn btn-outline-primary" title="Zoom arrière (Ctrl+-)">
                            🔍-
                        </button>
                        <button id="networkFit" class="btn btn-outline-primary" title="Ajuster à la vue (F)">
                            📐 Ajuster
                        </button>
                        <button id="networkCenter" class="btn btn-outline-primary" title="Centrer (C)">
                            🎯 Centrer
                        </button>
                    </div>
                    
                    <div class="btn-group btn-group-sm ml-2">
                        <button id="networkPhysics" class="btn btn-outline-success active" title="Simulation physique réaliste des mouvements">
                            ⚡ Physique
                        </button>
                        <button id="networkHierarchy" class="btn btn-outline-info" title="Organisation en arbre hiérarchique">
                            🌳 Hiérarchie
                        </button>
                        <button id="networkClustering" class="btn btn-outline-warning" title="Regroupement automatique des nodes similaires">
                            🔗 Cluster
                        </button>
                    </div>
                    
                    <!-- Filtres intégrés -->
                    <div class="network-filters ml-2">
                        <div class="form-group mb-0 mr-2">
                            <select id="filterCategory" class="form-control form-control-sm" style="width: 150px;">
                                <option value="">Toutes les catégories</option>
                            </select>
                        </div>
                        <div class="form-group mb-0 mr-2">
                            <input type="text" id="filterTag" class="form-control form-control-sm" placeholder="Filtrer par tag..." style="width: 150px;">
                        </div>
                        <button id="applyFiltersBtn" class="btn btn-outline-secondary btn-sm mr-2">Filtrer</button>
                        <button id="clearFiltersBtn" class="btn btn-outline-secondary btn-sm">Effacer</button>
                    </div>
                    
                    <div class="input-group input-group-sm ml-2" style="width: 200px;">
                        <input type="text" id="networkSearch" class="form-control" placeholder="Rechercher un node...">
                        <div class="input-group-append">
                            <button id="networkClearSearch" class="btn btn-outline-secondary" type="button" title="Effacer la recherche">
                                ❌
                            </button>
                        </div>
                    </div>
                    
                    <button id="networkFullscreenBtn" class="btn btn-primary btn-sm ml-2" title="Mode plein écran (Échap pour quitter)">
                        🔳 Plein écran
                    </button>
                </div>
                
                <!-- Explications des modes -->
                <div class="network-help-section">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="help-item">
                                <strong>⚡ Physique :</strong> 
                                <small class="text-muted">Simulation réaliste avec forces d'attraction/répulsion. Les nodes bougent naturellement.</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="help-item">
                                <strong>🌳 Hiérarchie :</strong> 
                                <small class="text-muted">Organisation en arbre par catégories. Structure fixe et ordonnée.</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="help-item">
                                <strong>🔗 Cluster :</strong> 
                                <small class="text-muted">Regroupement automatique des systèmes similaires pour simplifier la vue.</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Légende collapsible -->
                <div class="network-legend-integrated">
                    <div class="legend-header" onclick="toggleNetworkLegend()">
                        <h6 class="legend-title mb-0">
                            📊 Légende 
                            <span id="legendToggleIcon" class="legend-toggle-icon">▶</span>
                        </h6>
                        <small class="text-muted">Cliquer pour étendre/réduire</small>
                    </div>
                    
                    <div id="legendContent" class="legend-content collapsed">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="legend-section">
                                    <h6 class="legend-subtitle">🎯 Niveau de compromission (bordure)</h6>
                                    <div class="legend-items-grid">
                                        <div class="legend-item">
                                            <span class="legend-border-demo" style="border: 3px solid #95a5a6;"></span>
                                            <span>Non compromis</span>
                                        </div>
                                        <div class="legend-item">
                                            <span class="legend-border-demo" style="border: 4px solid #f1c40f;"></span>
                                            <span>Faible</span>
                                        </div>
                                        <div class="legend-item">
                                            <span class="legend-border-demo" style="border: 5px solid #e67e22;"></span>
                                            <span>Moyen</span>
                                        </div>
                                        <div class="legend-item">
                                            <span class="legend-border-demo" style="border: 6px solid #e74c3c;"></span>
                                            <span>Élevé</span>
                                        </div>
                                        <div class="legend-item">
                                            <span class="legend-border-demo" style="border: 7px solid #8e44ad;"></span>
                                            <span>Critique</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="legend-section">
                                    <h6 class="legend-subtitle">️ Types de systèmes (icône)</h6>
                                    <div class="legend-items-grid">
                                        <div class="legend-item">
                                            <span>🖥 Windows</span>
                                            <span>🐧 Linux</span>
                                            <span>🏛 DC</span>
                                        </div>
                                        <div class="legend-item">
                                            <span>🌐 Web</span>
                                            <span>🗄 Database</span>
                                            <span>📡 Router</span>
                                        </div>
                                        <div class="legend-item">
                                            <span>🛡 Firewall</span>
                                            <span>💻 Workstation</span>
                                            <span>❓ Autre</span>
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <small class="text-muted">
                                            💡 <strong>Couleur de fond :</strong> Catégorie | 
                                            <strong>Bordure :</strong> Niveau de compromission
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="network-controls-help">
                            <small class="text-muted">
                                💡 <strong>Raccourcis :</strong> F (ajuster), C (centrer), P (physique), H (hiérarchie), Ctrl+/- (zoom) | 
                                <strong>Interactions :</strong> Clic droit sur un node pour le menu contextuel, glisser pour déplacer
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="networkContainer"></div>
            
            <!-- Panneau d'informations du node sélectionné -->
            <div id="nodeInfoPanel" class="node-info-panel" style="display: none;">
                <div class="node-info-header">
                    <h6 id="nodeInfoTitle">Informations du Node</h6>
                    <button id="closeNodeInfo" class="btn btn-sm btn-outline-secondary">✕</button>
                </div>
                <div id="nodeInfoContent" class="node-info-content">
                    <!-- Contenu dynamique -->
                </div>
            </div>
        </div>

        <!-- Données Agrégées -->
        <div class="card aggregated-data-section mt-3"> <!-- Ajout de mt-3 -->
            <div class="card-header">
                Données Agrégées (Cliquer pour copier)
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <h5>Usernames</h5>
                        <pre id="allUsernames" class="copyable-data" title="Cliquer pour copier"></pre>
                    </div>
                    <div class="col-md-4">
                        <h5>Passwords</h5>
                        <pre id="allPasswords" class="copyable-data" title="Cliquer pour copier"></pre>
                    </div>
                    <div class="col-md-4">
                        <h5>Hashes</h5>
                        <pre id="allHashes" class="copyable-data" title="Cliquer pour copier"></pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section Rapports -->
        <div id="advancedReportsSection" class="collapsible-section">
            <div class="collapsible-header" onclick="toggleAdvancedReportsSection()">
                <h5 class="mb-0">📊 Génération de Rapports Avancée</h5>
                <div class="d-flex align-items-center">
                    <small class="text-muted mr-2">Créez des rapports techniques professionnels</small>
                    <span class="collapsible-toggle">▼</span>
                </div>
            </div>
            <div class="collapsible-content" id="advancedReportsContent">
                <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="report-controls">
                            <!-- Rapport Technique Seulement -->
                            <h6>🎯 Rapport Technique Disponible</h6>
                            <div class="report-types-grid mb-4">
                                <div class="report-type-card active" data-type="technical">
                                    <div class="report-type-header">
                                        <span class="report-icon">🔧</span>
                                        <h6>Rapport Technique</h6>
                                    </div>
                                    <p class="small text-muted">Détails techniques complets, preuves de concept et remédiation</p>
                                    <div class="report-type-options">
                                        <label class="small">
                                            <input type="checkbox" class="include-outputs-option" data-type="technical" checked> 
                                            Inclure outputs bruts
                                        </label>
                                        <label class="small">
                                            <input type="checkbox" class="include-screenshots-option" data-type="technical" checked> 
                                            Inclure screenshots
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Options de personnalisation avancées -->
                            <div class="report-customization">
                                <h6>🎨 Personnalisation du rapport</h6>
                                
                                <div class="form-row">
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="reportTitle">Titre du rapport</label>
                                            <input type="text" id="reportTitle" class="form-control form-control-sm" 
                                                   placeholder="Pentest - [Client] - [Date]">
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="reportAuthor">Auteur(s)</label>
                                            <input type="text" id="reportAuthor" class="form-control form-control-sm" 
                                                   placeholder="Équipe pentest">
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="reportClient">Client</label>
                                            <input type="text" id="reportClient" class="form-control form-control-sm" 
                                                   placeholder="Nom du client">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="reportStyle">Style visuel</label>
                                            <select id="reportStyle" class="form-control form-control-sm">
                                                <option value="professional">Professionnel (bleu/gris)</option>
                                                <option value="security">Sécurité (rouge/noir)</option>
                                                <option value="minimal">Minimaliste (noir/blanc)</option>
                                                <option value="corporate">Corporate (vert/bleu)</option>
                                                <option value="cyberpunk">Cyber (violet/néon)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="reportLanguage">Langue</label>
                                            <select id="reportLanguage" class="form-control form-control-sm">
                                                <option value="fr">Français</option>
                                                <option value="en">English</option>
                                                <option value="es">Español</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="reportFormat">Format de sortie</label>
                                            <div class="btn-group btn-group-toggle w-100" data-toggle="buttons">
                                                <label class="btn btn-outline-secondary btn-sm active">
                                                    <input type="radio" name="reportFormat" id="formatMarkdown" value="markdown" checked> 📝 Markdown
                                                </label>
                                                <label class="btn btn-outline-secondary btn-sm">
                                                    <input type="radio" name="reportFormat" id="formatHtml" value="html"> 🌐 HTML
                                                </label>
                                                <label class="btn btn-outline-secondary btn-sm">
                                                    <input type="radio" name="reportFormat" id="formatPdf" value="pdf"> 📄 PDF
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="reportDetailLevel">Niveau de détail</label>
                                            <select id="reportDetailLevel" class="form-control form-control-sm">
                                                <option value="summary">Résumé</option>
                                                <option value="detailed" selected>Détaillé</option>
                                                <option value="comprehensive">Complet</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label>📁 Catégories à inclure</label>
                                    <div id="reportCategoryFilters" class="category-filters">
                                        <!-- Généré dynamiquement -->
                                    </div>
                                </div>
                                
                                <!-- Options avancées collapsible -->
                                <div class="advanced-options mt-3">
                                    <button type="button" class="btn btn-link btn-sm p-0" data-toggle="collapse" data-target="#advancedReportOptions">
                                        ⚙️ Options avancées <span class="caret">▼</span>
                                    </button>
                                    <div id="advancedReportOptions" class="collapse mt-2">
                                        <div class="border p-3 bg-light rounded">
                                            <div class="form-row">
                                                <div class="col-md-6">
                                                    <div class="form-check">
                                                        <input type="checkbox" id="includeTableOfContents" class="form-check-input" checked>
                                                        <label for="includeTableOfContents" class="form-check-label">Table des matières</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input type="checkbox" id="includeExecutiveSummary" class="form-check-input" checked>
                                                        <label for="includeExecutiveSummary" class="form-check-label">Résumé exécutif en en-tête</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input type="checkbox" id="includeRecommendations" class="form-check-input" checked>
                                                        <label for="includeRecommendations" class="form-check-label">Recommandations prioritaires</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-check">
                                                        <input type="checkbox" id="includeTimeline" class="form-check-input">
                                                        <label for="includeTimeline" class="form-check-label">Timeline des activités</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input type="checkbox" id="includeMetrics" class="form-check-input" checked>
                                                        <label for="includeMetrics" class="form-check-label">Métriques et statistiques</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input type="checkbox" id="includeAppendices" class="form-check-input">
                                                        <label for="includeAppendices" class="form-check-label">Annexes techniques</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="d-flex justify-content-center align-items-center h-100">
                            <button type="button" id="generateTechnicalReport" class="btn btn-primary btn-lg">
                                🚀 Générer Rapport Technique
                            </button>
                        </div>
                        <div class="mt-3">
                            <h6>🎯 Filtres par catégorie :</h6>
                            <div id="reportCategoryFilters" class="category-filters">
                                <!-- Les filtres de catégories seront ajoutés ici par JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
                </div>
            </div>
        </div>

    </div> <!-- Fin #main-content -->

    <!-- Panneau d'Édition Hôte (Initialement caché) -->
    <!-- Placé HORS de main-content pour un positionnement fixe plus fiable -->
    <div id="editPanel" class="edit-panel">
        <!-- AJOUT DU BOUTON POUR AGRANDIR/RÉDUIRE -->
        <button id="toggleWidePanelBtn" class="toggle-wide-btn" title="Agrandir/Réduire">↔️</button>
        <button id="closePanelBtn" class="close-panel-btn" title="Fermer">&times;</button>
        <h3>Éditer Hôte</h3>
        <form id="editHostForm">
            <input type="hidden" id="editHostId">
            <input type="hidden" id="editHostCategory">

            <div class="form-group">
                <label for="editHostIpName">IP / Nom d'hôte:</label>
                <input type="text" id="editHostIpName" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="editHostServices">Services (séparés par virgule):</label>
                <input type="text" id="editHostServices" class="form-control">
            </div>
            <div class="form-group">
                <label for="editHostNotes">Notes:</label>
                <textarea id="editHostNotes" class="form-control" rows="4"></textarea>
            </div>
            <div class="form-group">
                <label for="editHostTags">Tags (séparés par virgule):</label>
                <input type="text" id="editHostTags" class="form-control">
            </div>

            <!-- === NOUVEAUX CHAMPS === -->
            <div class="form-group">
                <label for="editHostSystem">Système (OS/Type):</label>
                <select id="editHostSystem" class="form-control">
                    <option value="" selected>-- Non Spécifié --</option>
                    <option value="Linux">Linux</option>
                    <option value="Windows">Windows (Client/Serveur)</option>
                    <option value="Active Directory">Active Directory (DC)</option>
                    <option value="macOS">macOS</option>
                    <option value="Other">Autre</option>
                </select>
            </div>
            <div class="form-group">
                <label for="editHostRole">Rôle:</label>
                <input type="text" id="editHostRole" class="form-control" placeholder="ex: Domain Controller, Web Server...">
            </div>
            <div class="form-group">
                <label for="editHostZone">Zone Réseau:</label>
                <input type="text" id="editHostZone" class="form-control" placeholder="ex: Internal, DMZ, External, Cloud...">
            </div>
            <div class="form-group">
                <label for="editHostCompromiseLevel">Niveau Compromission:</label>
                <select id="editHostCompromiseLevel" class="form-control">
                    <option value="None" selected>None</option>
                    <option value="Initial Access">Initial Access</option>
                    <option value="User">User</option>
                    <option value="Admin/Root">Admin/Root</option>
                    <option value="Domain Admin">Domain Admin</option>
                </select>
            </div>
            <div class="form-group">
                <label for="editHostTechniques">Techniques Exploitation (séparées par virgule):</label>
                <textarea id="editHostTechniques" class="form-control" rows="2" placeholder="ex: Pass-the-Hash, SMB Relay, SQLi..."></textarea>
            </div>
            <!-- === FIN DES NOUVEAUX CHAMPS === -->

            <!-- Section Credentials -->
            <h4>Credentials</h4>
            <div id="editCredentialsContainer" class="mb-3"> <!-- Ajout mb-3 -->
                <!-- Les groupes de credentials seront ajoutés ici par JS avec la nouvelle structure -->
            </div>
            <button type="button" id="addCredentialBtn" class="btn btn-secondary btn-sm mb-3">Ajouter Credential</button>

            <!-- Section Edges -->
            <h4>Connexions Sortantes (Edges)</h4>
            <div class="form-group form-inline mb-2 flex-wrap">
                <label for="editEdgeTo" class="mr-2 mb-1">Vers:</label>
                <input type="text" id="editEdgeTo" placeholder="IP/Nom Hôte Cible" class="form-control form-control-sm mr-2 mb-1 flex-grow-1">
                <label for="editEdgeLabel" class="mr-2 mb-1">Label:</label>
                <input type="text" id="editEdgeLabel" placeholder="ex: RDP, SSH" class="form-control form-control-sm mr-2 mb-1 flex-grow-1">
                <button type="button" id="addEdgeBtn" class="btn btn-secondary btn-sm mb-1">Ajouter Connexion</button>
            </div>
            <div id="existingEdgesList" class="mb-3">
                <!-- Les edges existants seront listés ici par JS -->
            </div>



            <!-- ======================================== -->
            <!-- == NOUVELLE SECTION ÉTAPES EXPLOITATION == -->
            <!-- ======================================== -->
            <div id="exploitationStepsSection" class="mt-4 pt-3 border-top">
                <h4>Étapes d'Exploitation</h4>
                <div id="exploitationStepsList" class="list-group mb-3">
                    <!-- Les étapes seront listées ici par JS -->
                    <p class="text-muted small no-exploitation-steps-msg">Aucune étape d'exploitation enregistrée pour cet hôte.</p>
                </div>
                <button type="button" id="addExploitationStepBtn" class="btn btn-secondary btn-sm mb-3">
                    <i class="icon-plus"></i> Ajouter une Étape
                </button>
            </div>
            <!-- ======================================== -->
            <!-- == FIN SECTION ÉTAPES EXPLOITATION == -->
            <!-- ======================================== -->

            <!-- Boutons d'action -->
            <div class="edit-panel-actions">
                <button type="submit" class="btn btn-primary">Sauvegarder Modifications</button>
                <button type="button" id="deleteHostFromPanelBtn" class="btn btn-danger">Supprimer cet Hôte</button>
            </div>
        </form>
    </div>

    <!-- MODALE POUR LES DÉTAILS D'UNE ÉTAPE D'EXPLOITATION (Initialement cachée) -->
    <div class="modal fade" id="exploitationStepDetailModal" tabindex="-1" aria-labelledby="exploitationStepDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl"> <!-- modal-xl pour plus d'espace -->
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exploitationStepDetailModalLabel">Détails de l'Étape</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="exploitationStepDetailForm">
                        <input type="hidden" id="stepDetailModalStepId">
                        
                        <!-- Informations de base -->
                        <div class="form-group row">
                            <label for="stepDetailModalOrder" class="col-sm-2 col-form-label">Ordre:</label>
                            <div class="col-sm-2">
                                <input type="number" class="form-control form-control-sm" id="stepDetailModalOrder" min="1" step="1" required>
                            </div>
                            <label for="stepDetailModalTitle" class="col-sm-2 col-form-label">Titre:</label>
                            <div class="col-sm-6">
                                <input type="text" class="form-control form-control-sm" id="stepDetailModalTitle" placeholder="Ex: Scan Initial, Escalade Privilèges..." required>
                            </div>
                        </div>

                        <!-- CVE et Outil -->
                        <div class="form-group row">
                            <label for="stepDetailModalCVE" class="col-sm-2 col-form-label">CVE:</label>
                            <div class="col-sm-4">
                                <input type="text" class="form-control form-control-sm" id="stepDetailModalCVE" placeholder="Ex: CVE-2021-44228">
                            </div>
                            <label for="stepDetailModalTool" class="col-sm-2 col-form-label">Outil:</label>
                            <div class="col-sm-4">
                                <input type="text" class="form-control form-control-sm" id="stepDetailModalTool" placeholder="Ex: nmap, metasploit, sqlmap">
                            </div>
                        </div>

                        <!-- Sévérité -->
                        <div class="form-group row">
                            <label for="stepDetailModalSeverity" class="col-sm-2 col-form-label">Sévérité:</label>
                            <div class="col-sm-4">
                                <select class="form-control form-control-sm" id="stepDetailModalSeverity">
                                    <option value="Low">🟢 Low</option>
                                    <option value="Medium" selected>🟡 Medium</option>
                                    <option value="High">🟠 High</option>
                                    <option value="Critical">🔴 Critical</option>
                                </select>
                            </div>
                        </div>

                        <!-- Description -->
                        <div class="form-group">
                            <label for="stepDetailModalDescription">Description:</label>
                            <textarea class="form-control" id="stepDetailModalDescription" rows="3" placeholder="Description détaillée de l'étape d'exploitation..."></textarea>
                        </div>

                        <!-- Commande -->
                        <div class="form-group">
                            <label for="stepDetailModalCommand">Commande utilisée:</label>
                            <textarea class="form-control" id="stepDetailModalCommand" rows="3" placeholder="Collez ici la commande exacte utilisée..."></textarea>
                        </div>

                        <!-- Output/Résultat -->
                        <div class="form-group">
                            <label for="stepDetailModalOutput">Output/Résultat:</label>
                            <textarea class="form-control" id="stepDetailModalOutput" rows="6" placeholder="Collez ici l'output de la commande ou les résultats obtenus..."></textarea>
                        </div>

                        <!-- Notes -->
                        <div class="form-group">
                            <label for="stepDetailModalNotes">Notes additionnelles:</label>
                            <textarea class="form-control" id="stepDetailModalNotes" rows="2" placeholder="Notes, observations, liens utiles..."></textarea>
                        </div>

                        <!-- Screenshots -->
                        <div class="form-group">
                            <label>📸 Screenshots:</label>
                            <div class="screenshots-container" id="stepDetailModalScreenshotsContainer">
                                <div class="screenshot-upload-area" id="stepDetailModalScreenshotUploadArea">
                                    <div class="upload-instructions">
                                        <i class="fas fa-image fa-2x mb-2"></i>
                                        <p>Collez une image (Ctrl+V) ou glissez-déposez un fichier</p>
                                        <input type="file" id="stepDetailModalScreenshotFile" accept="image/*" multiple style="display: none;">
                                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="document.getElementById('stepDetailModalScreenshotFile').click()">
                                            <i class="fas fa-folder-open"></i> Choisir des fichiers
                                        </button>
                                    </div>
                                </div>
                                <div id="stepDetailModalScreenshotsPreview" class="screenshots-preview">
                                    <!-- Les screenshots seront ajoutés ici -->
                                </div>
                            </div>
                        </div>

                        <!-- URL Screenshot (fallback) -->
                        <div class="form-group">
                            <label for="stepDetailModalScreenshotUrl">URL/Chemin Capture d'écran (Optionnel):</label>
                            <input type="text" class="form-control form-control-sm" id="stepDetailModalScreenshotUrl" placeholder="Ex: /screenshots/step1.png ou http://.../image.jpg">
                        </div>
                        <div id="stepDetailModalScreenshotPreview" class="mt-2" style="max-height: 200px; overflow: auto;">
                            <!-- L'aperçu de l'image sera chargé ici si une URL est valide -->
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                    <button type="button" id="saveExploitationStepBtn" class="btn btn-primary">Sauvegarder Étape</button>
                </div>
            </div>
        </div>
    </div>
    <!-- FIN MODALE -->

    <!-- Panneau Paramètres Catégorie (Initialement caché) -->
    <!-- Placé HORS de main-content -->
    <div id="categorySettingsPanel" class="edit-panel category-settings-panel">
        <button id="closeCategorySettingsPanelBtn" class="close-panel-btn" title="Fermer">&times;</button>
        <h3 id="categorySettingsPanelTitle">Paramètres Catégorie</h3>
        <form id="categorySettingsForm">
            <input type="hidden" id="settingsCategoryName">
            <div class="form-group">
                <label for="categoryTemplateTypeSelect">Type de Template Associé:</label>
                <select id="categoryTemplateTypeSelect" class="form-control">
                    <option value="">Aucun</option>
                </select>
                <small class="form-text text-muted">Affecte le template utilisé lors de la génération du rapport Killchain...</small>
            </div>
            <button type="button" id="saveCategorySettingsBtn" class="btn btn-primary">Sauvegarder Paramètres</button>
        </form>
    </div>

    <!-- Footer -->
    <footer class="main-footer">
        <div class="footer-content">
            <p>Made with ❤️ by Elliot Belt - AuditMapper Security Suite</p>
        </div>
    </footer>

    <!-- Scripts de base -->
    <script src="/assets/js/sidebar.js"></script>
    <script src="/assets/js/theme.js"></script>
    <script src="/assets/js/language.js"></script>

    <!-- Scripts HostManager - DANS L'ORDRE CORRECT -->
    <script type="module" src="/assets/js/hostmanager/main.js"></script>

    <!-- Script pour le toggle des sections collapsibles -->
    <script>
        function toggleExportImportSection() {
            const content = document.getElementById('exportImportContent');
            const toggle = document.querySelector('.collapsible-toggle');
            
            if (content && toggle) {
                content.classList.toggle('collapsed');
                toggle.classList.toggle('collapsed');
            }
        }

        function toggleAdvancedReportsSection() {
            const content = document.getElementById('advancedReportsContent');
            const toggle = document.querySelector('#advancedReportsSection .collapsible-toggle');
            
            if (content && toggle) {
                content.classList.toggle('collapsed');
                toggle.classList.toggle('collapsed');
            }
        }

        function toggleNetworkLegend() {
            const legendContent = document.getElementById('legendContent');
            const toggleIcon = document.getElementById('legendToggleIcon');
            
            if (legendContent && toggleIcon) {
                const isCollapsed = legendContent.classList.contains('collapsed');
                
                if (isCollapsed) {
                    legendContent.classList.remove('collapsed');
                    toggleIcon.classList.remove('collapsed');
                    toggleIcon.textContent = '▼';
                } else {
                    legendContent.classList.add('collapsed');
                    toggleIcon.classList.add('collapsed');
                    toggleIcon.textContent = '▶';
                }
            }
        }

        // Fermer les sections par défaut pour économiser l'espace
        document.addEventListener('DOMContentLoaded', function() {
            // Section Export/Import
            const exportContent = document.getElementById('exportImportContent');
            const exportToggle = document.querySelector('.collapsible-toggle');
            
            if (exportContent && exportToggle) {
                exportContent.classList.add('collapsed');
                exportToggle.classList.add('collapsed');
            }

            // Section Rapports Avancés
            const reportsContent = document.getElementById('advancedReportsContent');
            const reportsToggle = document.querySelector('#advancedReportsSection .collapsible-toggle');
            
            if (reportsContent && reportsToggle) {
                reportsContent.classList.add('collapsed');
                reportsToggle.classList.add('collapsed');
            }
        });
    </script>
</body>
</html>